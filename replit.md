# لعبة تخمين الأرقام العربية

## نظرة عامة

لعبة تخمين أرقام تفاعلية عربية مع واجهة 2D حديثة. اللاعبون يخمنون رقماً سرياً ويتلقون تعليقات على دقة التخمين. تدعم اللعبة الوضع الفردي والجماعي مع تواصل فوري عبر WebSocket وتحديات صغيرة للحصول على تلميحات. اللعبة مصممة للعمل على الهاتف والحاسوب بسلاسة.

## تفضيلات المستخدم

أسلوب التواصل المفضل: لغة بسيطة وسهلة الفهم.

## البنية المعمارية

### الواجهة الأمامية (Frontend)

**مجموعة التقنيات:**
- React 18 مع TypeScript
- Vite للبناء والتطوير
- TailwindCSS للتصميم
- Radix UI للمكونات الأساسية
- Zustand لإدارة الحالة

**استراتيجية العرض:**
- **ديسكتوب**: واجهة كاملة مع لوحة المحاولات السابقة على الجانب
- **موبايل**: واجهة محسنة مع لوحة أرقام مخصصة، كشف تلقائي عند 768px

**المكونات الرئيسية:**
- `MobileSingleplayer` و `DesktopSingleplayer`: واجهات اللعب الفردي (موحدة التصميم)
- `MultiplayerLobby`: غرفة انتظار اللعب الجماعي
- `MultiplayerGame2D`: واجهة اللعب الجماعي (ديسكتوب) و `MobileMultiplayer` (موبايل)
- `RainDropsChallenge`, `DirectionChallenge`, `MemoryChallenge`, `GuessChallenge`: التحديات الأربعة
- `CardSystem`: نظام البطاقات الحصري للعب الجماعي

**إدارة الحالة:**
- `useNumberGame`: الحالة الرئيسية للعبة (وضع فردي وجماعي)
- `useChallenges`: حالة التحديات والتلميحات
- `useCards`: نظام البطاقات الخاص
- `useAudio`: إدارة المؤثرات الصوتية
- `useAccount`: نظام الحسابات والأصدقاء (مع persist في localStorage)

**التواصل بين العميل والخادم:**
- WebSocket للعب الجماعي الفوري
- حفظ الجلسة عبر sessionStorage للاتصال المفقود
- رسائل: challenge_completed, start_game, submit_guess, وغيرها

### الخادم (Backend)

**مجموعة التقنيات:**
- Express.js مع TypeScript
- WebSocket (ws) للتواصل الفوري
- Neon PostgreSQL مع Drizzle ORM (متوفر للاستخدام المستقبلي)

**بنية الخادم:**
- `server/index.ts`: إعداد Express والـ middleware
- `server/routes.ts`: خادم WebSocket ومنطق اللعبة
- `server/db.ts`: اتصال قاعدة البيانات
- `server/storage.ts`: واجهة التخزين (في الذاكرة حالياً)

**منطق اللعبة:**
- نظام غرف مع معرفات فريدة
- لعب مستقل وفوري (الاثنان يلعبان بنفس الوقت)
- أكواز سرية مشتركة تولد تلقائياً
- تحديات ما قبل اللعبة: جميع اللاعبين يكملون التحدي قبل بدء المؤقت
- نظام إعادة اتصال شامل:
  - تخزين اللاعبين المقطوعين مع timeout 5 دقائق
  - حفظ بيانات اللعبة (المحاولات والنقاط)
  - تنظيف تلقائي للغرف المهجورة
  - مزامنة حالة اللعبة بين جميع العملاء

## تخزين البيانات

**قاعدة البيانات:**
- PostgreSQL عبر Neon
- Drizzle ORM لاستعلامات آمنة
- جداول: accounts, friendRequests, friendships, notifications

**إدارة الجلسات:**
- تتبع اتصالات WebSocket لكل لاعب
- حالة الغرفة محفوظة في ذاكرة الخادم (Map)
- تخزين الجلسة محلي للاتصال بعد التحديث (انتهاء الصلاحية بعد 30 دقيقة)
- انقطاع 5 دقائق للاعبين المقطوعين في الألعاب النشطة

## اختيارات التصميم النظامي

**تجربة المستخدم:**
- تصميم متجاوب لكل من ديسكتوب وموبايل
- واجهة عربية كاملة مع تخطيط من اليمين لليسار
- نظام التصويت على إعادة اللعب مع بدء لحظي عند الموافقة
- شاشة نتائج محسنة مع رتب وحركات احتفال
- شاشة انتظار عندما ينتهي لاعب من التحدي قبل الآخرين

**التطبيقات التقنية:**
- مؤقت حي مع تحديثات 100ms وTimeout 5 دقائق
- كشف الخسارة الفوري عند الوصول لأقصى عدد محاولات
- نظام إعادة اتصال قوي يستعيد كل حالة اللعبة
- تحديات صغيرة: "تحدي الذاكرة" و"تحدي الاتجاهات" و"تحدي حبات المطر" و"تحدي التسلسل" مع تعليقات بصرية وسمعية
- نظام بطاقات فريد مع 6 أنواع (إظهار رقم، حرق رقم، كشف زوجي/فردي، تجميد، درع، تعطيل عرض)

## التحسينات الأخيرة

### إضافة 4 ديسمبر - الغرف الدائمة والإشعارات:
1. **الغرف الدائمة**: نظام غرف دائمة تستمر في قاعدة البيانات لمدة 24 ساعة
   - جداول: permanentRooms, permanentRoomMembers
   - API Endpoints: /api/permanent-rooms/create, /api/permanent-rooms/:roomId, /api/permanent-rooms/user/:userId, /api/permanent-rooms/join, /api/permanent-rooms/leave
   - كل مستخدم يمكنه إنشاء غرفة دائمة واحدة فقط
   - صاحب الغرفة هو القائد تلقائياً
2. **نظام الإشعارات عند الاتصال**: إشعار الأصدقاء وأعضاء الغرفة الدائمة عند اتصال المستخدم
   - إشعارات Push للأصدقاء عند الاتصال
   - إشعارات Push لأعضاء الغرفة الدائمة
3. **إصلاح بدء اللعبة**: القائد يُحتسب جاهزاً تلقائياً - يحتاج لاعب واحد إضافي جاهز فقط لبدء اللعبة
4. **إصلاحات LSP**: إصلاح أخطاء TypeScript في CardSettings interface و Map iterators

### إصلاح 3 ديسمبر - إصلاحات متعددة:
1. **إصلاح شاشة الموبايل البيضاء**: إصلاح hook useIsMobile لتهيئة حالة الموبايل بشكل صحيح من أول عرض
2. **إصلاح DesktopSingleplayer**: استخدام actions الـ Zustand store الصحيحة (addDigitToGuess, deleteLastDigit, submitGuess) بدلاً من setState اليدوي
3. **تحديث واجهة DesktopSingleplayer**: توحيد التصميم مع MultiplayerGame2D (شريط علوي، عمودين، أزرار الإعدادات)
4. **تخطيط ChallengesHub**: عرض التحديات جنباً لجنب على الديسكتوب (grid-cols-2 lg:grid-cols-3)
5. **تحديث Service Worker**: تحديث إصدار الكاش إلى v3 لضمان تحديث المستخدمين

### إضافة 2 ديسمبر - نظام الحسابات والأصدقاء:
1. **نظام الحسابات**: إنشاء حسابات بسيطة (اسم + اسم مستخدم فريد) بدون بريد إلكتروني
2. **نظام الأصدقاء**: بحث عن مستخدمين، إرسال طلبات صداقة، قبول/رفض الطلبات
3. **دعوات الغرف**: دعوة الأصدقاء للانضمام للغرف في اللعب الجماعي
4. **الإشعارات**: نظام إشعارات مع عداد للإشعارات غير المقروءة
5. **مكونات UI جديدة**:
   - AccountDialog: تسجيل الدخول وإنشاء الحسابات
   - FriendsDialog: إدارة الأصدقاء ودعوتهم للغرف
   - NotificationsDropdown: عرض الإشعارات
   - RoomInviteDialog: قبول دعوات الغرف
6. **API Routes جديدة**: /api/accounts/*, /api/friends/*, /api/notifications/*, /api/invite/*

### إصلاح 29 نوفمبر (3):
1. **سرعة تحدي حبات المطر**: إزالة تسارع السرعة المفرط في آخر 10-15 ثانية
2. **موضع الإشعارات**: تغيير موضع إشعارات الموبايل من أعلى-وسط إلى أسفل-وسط مع z-index مناسب
3. **حفظ إعدادات الغرفة**: إضافة localStorage لحفظ واستعادة الإعدادات عبر الجلسات
4. **مزامنة المؤقت**: إضافة timestamp الخادم في رسالة game_starting للمزامنة
5. **عرض المؤقت**: تغيير العرض من الوقت المتبقي إلى الوقت المنقضي
6. **عرض زوجي/فردي**: إضافة معلومات التكافؤ كنص خلفية في خانات الإدخال (ديسكتوب وموبايل)
7. **منع تكرار البطاقات**: إصلاح مشكلة تكرار البطاقات عند إعادة اللعب بمسح playerCards
8. **حفظ إعدادات البطاقات**: حفظ cardSettings عند إعادة اللعب بدلاً من إعادة تعيينها

### إصلاح 29 نوفمبر (2):
1. **مزامنة مؤقت الجولة**: إصلاح مشكلة عدم تزامن إعدادات البطاقات بين اللاعبين عند تغيير المضيف للإعدادات
2. **إخفاء إشعار بطاقة الحرق**: البطاقة تعمل لكن دون إظهار إشعار للمستخدم
3. **إصلاح البطاقات عند إعادة اللعب**: إعادة تعيين حالة التحديات والبطاقات بشكل صحيح
4. **سجل الجولات**: إضافة زر لعرض سجل الجولات السابقة في صفحة النتائج مع عرض الفائزين والخاسرين

### إصلاح 29 نوفمبر (1):
1. **تصحيح CardIcon**: الأيقونات الآن مطابقة صحيحة للبطاقات (eye, x-circle, hash, snowflake, shield, eye-off)
2. **توحيد تصميم UI**: MobileSingleplayer و MobileMultiplayer الآن بنفس الهيكل والتصميم
3. **شاشة الانتظار**: إضافة رسالة انتظار عندما ينتهي لاعب من التحدي قبل اللاعبين الآخرين
4. **رسالة challenge_completed**: إرسال رسالة للخادم عند انتهاء لاعب من التحدي

## التبعيات الخارجية

**مكتبة مكونات الواجهة:**
- `@radix-ui/*`: مجموعة شاملة من العناصر الآمنة
- `lucide-react`: أيقونات عالية الجودة

**قاعدة البيانات والخادم:**
- `@neondatabase/serverless`, `drizzle-orm`, `drizzle-kit`, `ws`

**التصميم:**
- `tailwindcss`, `class-variance-authority`, `clsx`, `tailwind-merge`

**إدارة الحالة والبيانات:**
- `@tanstack/react-query`, `zustand`

**الوسائط والأصوات:**
- `@fontsource/inter`, `howler`, `react-confetti`, `framer-motion`

**أدوات التطوير:**
- `@replit/vite-plugin-runtime-error-modal`, `tsx`, `esbuild`, `vite`

## ملاحظات التطوير

### نقاط مهمة:
1. تأكد من أن الواجهات يمكن تمريرها عند اللعب
2. الأسهم في تحدي الاتجاهات معكوسة على الكمبيوتر (RTL) لكن صحيحة على الموبايل
3. الأخطاء تنقص الفرص من 3 إلى 2 إلى 1
4. نظام البطاقات حصري للعب الجماعي فقط
5. جميع النصوص يجب أن تكون بالعربية
6. شاشة الانتظار تظهر عندما startTime === 0 (الانتظار لجميع اللاعبين)

### الملفات المهمة:
- `client/src/components/mobile/MobileSingleplayer.tsx` (موحد مع المتعدد الآن)
- `client/src/components/desktop/DesktopSingleplayer.tsx`
- `client/src/components/mobile/MobileMultiplayer.tsx` (مع شاشة انتظار)
- `client/src/components/desktop/MultiplayerGame2D.tsx` (مع شاشة انتظار)
- `client/src/components/game/challenges/`
- `client/src/lib/stores/useChallenges.ts`
- `client/src/lib/stores/useCards.ts`
- `client/src/lib/stores/useAccount.ts` (نظام الحسابات والأصدقاء)
- `client/src/components/game/cards/CardSystem.tsx` (أيقونات مصححة)
- `client/src/components/ui/AccountDialog.tsx` (تسجيل الدخول)
- `client/src/components/ui/FriendsDialog.tsx` (إدارة الأصدقاء)
- `client/src/components/ui/NotificationsDropdown.tsx` (الإشعارات)
- `server/routes.ts`
- `server/storage.ts` (مع functions للحسابات والأصدقاء)
- `shared/schema.ts` (جداول قاعدة البيانات)
