1. إصلاح مشكلة الـ Ready بعد نهاية الجولة

حالياً عندما تنتهي الجولة ويقوم القائد ببدء مباراة جديدة:

يظهر للاعبين أنهم جاهزون Ready بينما هم فعلياً غير جاهزين.

يظهر تحذير: "يجب أن يكون هناك لاعب واحد جاهز على الأقل (القائد جاهز تلقائياً)".

يظهر زر العودة للقائمة الرئيسيّة لجميع اللاعبين.

المطلوب:

بعد نهاية الجولة وعند إعادة البدء، لا يجب أن يظهر نظام الجاهزية إطلاقاً.

بمجرد أن يضغط القائد "إعادة المباراة" تبدأ مباشرة بدون Ready.

زر الرجوع للغرفة يظهر للقائد فقط—not للاعبين.

2. إضافة أدوات الإدارة للقائد

أحتاج إضافة ميزتين جديدتين داخل الغرفة للقائد فقط:

المطلوب:

زر طرد لاعب (Kick).

زر نقل القيادة (Transfer Host) إلى لاعب آخر.

التأكد من أن هذه الصلاحيات لا تظهر إلا لـ صاحب الغرفة فقط.

3. تحسين نظام WebSocket وإعادة الاتصال

النظام الحالي يعاني من:

عدم استعادة الاتصال بشكل صحيح.

اختفاء حالة الجلسة عند الانتقال بين الصفحات.

تداخل في الربط بين اللاعب و WebSocket.

مشاكل بعد نهاية الجولة بسبب إعادة تهيئة غير صحيحة للـ state.

المطلوب:

إعادة تنظيم نظام الاتصال بحيث يتوافق مع التسلسل التالي:

أريد نفس منطق reconnect الموجود في اللعبة الثانية:



عند فتح المتصفح:


يتم إنشاء WebSocket


إذا وُجد sessionToken + roomCode
→ يتم إرسال رسالة reconnect للعودة للغرفة السابقة.




عند انقطاع الاتصال:


اللاعب لا يتم حذفه من الغرفة


يتم وضعه في حالة "Disconnected"




عند إعادة الاتصال:


يعود إلى الغرفة دون إنشاء لاعب جديد.





رابعاً — تحديث نظام الغرف ليتطابق مع نظام اللعبة الثانية
إنشاء غرفة
نفس منطق اللعبة الثانية:



يولد roomId


playerId


sessionToken


hostId = playerId


إرسال الحالة الكاملة للعميل


الانضمام لغرفة
نفس منطق اللعبة الثانية:



انضمام عبر كود أو رابط مباشر


إرسال حالة الغرفة كاملة


بثّ دخول اللاعب للجميع


التخزين والبث
تطبيق نفس Maps:

const clients = new Map<playerId, WebSocket>();
const playerConnections = new Map<WebSocket, playerId>();

ونفس broadcast:

broadcastToRoom(roomId, message)


خامساً — إدارة مراحل اللعبة (Phases)
طبق نظام اللعبة الثانية حرفياً:



lobby


in-game


post-game


مع تعديل مهم:

عند post-game → restart:


القائد فقط يستطيع البدء


يبدأ فوراً بدون ready


إعادة ضبط نقاط اللاعبين أو الإعدادات المطلوبة



3. المطلوب بالضبط
أريد منك:

✔ دمج كل ميزات اللعبة الثانية في اللعبة الحالية
✔ استخدام نفس بنية النظام (create/join/reconnect/storage/broadcast)
✔ تطبيق التعديلات الخاصة بنهاية الجولة وصلاحيات القائد
✔ إصلاح مشكلة الجاهزية بالكامل
✔ تحسين إدارة WebSocket والاتصال بالجلسة الحالية